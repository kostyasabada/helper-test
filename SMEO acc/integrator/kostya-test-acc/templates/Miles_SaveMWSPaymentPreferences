<#assign businessPartnerId = body.businessPartnerId/>
<#assign validFromDate = .now?date>
<#-- Add three years minus one day -->
<#assign validToDate = (.now?long + 94521600000)?number_to_date>
    <#if headers.restConnectorProperties.environment != "DHC">
        <#assign businessPartnerId = "976314"/>
    </#if>

<#if body.data.MWSPaymentPreference_Set?? && body.data.MWSPaymentPreference_Set?is_hash >
    <?xml version="1.0" encoding="UTF-8"?>
    <SofEnvelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
        <sessionID>${body.MILES_sessionID}</sessionID>
        <businesspartnerid>${businessPartnerId}</businesspartnerid>
        <ignoreinteractive>false</ignoreinteractive>
        <data>
            <@JSONToXML node=body.data />
        </data>
        <metadata>
            <@JSONToXML node=body.metadata />
        </metadata>
    </SofEnvelope>
    
<#else>
    <?xml version="1.0" encoding="UTF-8"?>
    <SofEnvelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
        <sessionID>${body.MILES_sessionID}</sessionID>
        <businesspartnerid>${businessPartnerId}</businesspartnerid>
        <data>
          <MWSPaymentPreference_Set>
              <MWSPaymentPreference>
                <id/>
                <reference>ACLES${body.QuoteIdWithoutPrefix}001</reference>
                <paymentMethod id="425933" type="176" group="1072">Sepa Direct Debit</paymentMethod>
                <refundMethod id="425933" type="176" group="1072">Sepa Direct Debit</refundMethod>
                <#if body.preferenceStatus = "Allowed">
                	<preferenceStatus id="2111" type="483" group="2938">Allowed</preferenceStatus>
                <#else>
                	<preferenceStatus id="425936" type="483" group="2939">Requested</preferenceStatus>
                </#if>
                <validFrom>${validFromDate?iso_utc}</validFrom>
                <validTo>${validToDate?iso_utc}</validTo>
                <accountId>${body.bankAccountId}</accountId>
                <account>${body.bankAccount}</account>
              </MWSPaymentPreference>
            </MWSPaymentPreference_Set>
      </data>
      <metadata>
        <operationstatus businesserror="true" technicalerror="true" calculationerror="true" />
      </metadata>
</SofEnvelope>
 
</#if>
